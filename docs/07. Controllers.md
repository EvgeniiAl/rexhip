### Controllers

The controllers is the part om the library that contain the modbus block from TIA-portal.

All queries bellonging to a controller need to be called in the same order for at each plc scan. This implies they need to be called from the same OB as the controller.

#### TCP program
The following blocks can be delete if only the tcp part is used: mb_master_1200_ctrl, mb_master_1500_ctrl, mb_internal_b, mb_internal_h, mb_internal_f.
- Remember to set long enough timeout for remote networks.
- Make sure that conn_id is unique for tcp connection in the plc.

```pascal
#mb_client_ctrl(interface := "Local~PROFINET_interface_1", 
                conn_id := 1, 
                ip_addr := _array_of_byte_in_,
                tcp_port := 502,
                timeout := T#1S,
                error => _bool_out_ ,
                mb_query := #mb_query);

// mb_delay, this function will halt the execution for a certain amount of 
// time. This useful in modbus tcp, so the client doesn't jam a network.
#mb_delay(delay := T#2s, mb_query := #mb_query);
```

Changing advanced parameters is possible by reache them inside the controller:   
- #mb_client_ctrl.client.Blocked_Proc_Timeout
- #mb_client_ctrl.client.MB_Transaction_ID   
- #mb_client_ctrl.conf.retries
- #mb_client_ctrl.conf.disconnect

#### RTU program
There are two controllers for modbus rtu, one S7-1200 and one other for S7-1500, delete the one that is not used. mb_client_ctrl can also be deleted if there is no modbus tcp.

- Even parity is default, according to the modbus specification. If for some reason this need to be change it can be done with: #mb_master_ctrl.conf.parity
- Timeout is calculated automatically according to the baud rate, but not according to telegram length and the number of repeaters. The timeout can be ajusted with: #mb_master_ctrl.conf.timeout
- For the hardware_id, use the constant in tiaportal instead writing the number of the port. This increase readability, and decrease changes of bugs. 
- When the library is imported in to a S7-1500, the mb_master_1200_ctrl generate a lot of errors, delete the block to get rid of them.
- If the mb_master_1500_ctrl is used, then remember set the operation_mode input parameter: 0=>RS-232 ; 1-3=>RS-422 ; 4=>RS-485 (default)

```pascal
#mb_master_ctrl(hardware_id := "Local~CB_1241_(RS485)", 
                operating_mode := 4, // 4 => RS-485 (Only mb_master_1500_ctrl)
                baud := 19200,  
                timeout := T#0ms, // 0 => auto
                error => _bool_out_ ,
                mb_query := #mb_query );
```

Changing advanced parameters is possible by reache them inside the controller:   
- #mb_master_ctrl.comm_load.FLOW_CTRL   
- #mb_master_ctrl.comm_load.RTS_OFF_DLY
- #mb_master_ctrl.comm_load.RTS_ON_DLY
- #mb_master_ctrl.comm_load.ICHAR_GAP
- #mb_master_ctrl.master.Blocked_Proc_Timeout
- #mb_master_ctrl.master.EXTENDED_ADDRESSING
- #mb_master_ctrl.master.BLOCKED_PROC_TIMEOUT
- #mb_master_ctrl.conf.retries
- #mb_master_ctrl.conf.parity

#### Same memory

If the library is only used for tcp then all blocks related to rtu can be removed to save memory. Equally all tcp blocks can be removed if the library is only used for rtu. There are two solution for rtu application one for S7-1200, mb_master_ctrl. And there is one other for S7-1500, mb_master_1500_ctrl. Delete the block that isn't used to save memory.
